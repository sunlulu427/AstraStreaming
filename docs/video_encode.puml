@startuml
title 视频编码链路

' Subtle color scheme - highlight only core components
skinparam participant {
  BackgroundColor #2b2b2b
  BorderColor #999999
  FontColor #f0f0f0
}
skinparam participant<<control>> {
  BackgroundColor #4a4a4a
  BorderColor #777777
  FontColor #f0f0f0
}
skinparam participant<<core>> {
  BackgroundColor #D4AF37
  BorderColor #B8941F
  FontColor #2b2b2b
}
skinparam participant<<infrastructure>> {
  BackgroundColor #2b2b2b
  BorderColor #555555
  FontColor #cccccc
}
skinparam ArrowColor #c0c0c0
skinparam defaultFontName "JetBrains Mono"

participant StreamController <<control>>
participant VideoController <<control>>
participant CameraRecorder <<infrastructure>>
participant "EncodeRendererThread" as EncodeGL <<core>>
participant VideoEncoder <<core>>
participant "MediaCodec(H.264)" as MediaCodec <<infrastructure>>
participant Packer <<core>>

StreamController -> VideoController: start()
VideoController -> CameraRecorder: start()
CameraRecorder -> EncodeGL: start()
EncodeGL -> VideoEncoder: onSurfaceCreate()/onDraw()
VideoEncoder -> MediaCodec: configure(Surface, format)
VideoEncoder -> MediaCodec: start()

loop 每帧
  EncodeGL -> Surface: glDrawArrays(编码输入纹理)
  MediaCodec --> VideoEncoder: dequeueOutputBuffer(BufferInfo)
  VideoEncoder -> VideoController: onVideoEncode(buffer,info)
  VideoController -> StreamController: onVideoData(buffer,info)
  StreamController -> Packer: onVideoData(buffer,info)
end

note over MediaCodec
输出包含 NALU + BufferInfo;
StreamController 在 onVideoOutformat 中提取 SPS/PPS。
end note

@enduml
